<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="A new version of Vulpea library that is focused on query performance">
    <meta property="og:title" content="Boris Buliga - Vulpea v0.3" />
    <meta property="og:description" content="A new version of Vulpea library that is focused on query performance" />
    <meta property="og:image" content="https://d12frosted.io/images/d12frosted.png" />
    <meta property="og:url" content="https://d12frosted.io/posts/2022-07-14-vulpea-0.3.html" />
    <meta property="og:type" content="article" />
    <title>Boris Buliga - Vulpea v0.3</title>
    <link rel="stylesheet" href="../css/default.css" />
    <link rel="stylesheet" href="../css/fonts.css" />
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
    <link rel="manifest" href="../site.webmanifest">

    <!-- <script defer src="/library/@fortawesome/fontawesome-free/js/solid.js"></script> -->
    <!-- <script defer src="/library/@fortawesome/fontawesome-free/js/brands.js"></script> -->

    <link href="../library/@fortawesome/fontawesome-free/css/fontawesome.min.css" rel="stylesheet">
    <link href="../library/@fortawesome/fontawesome-free/css/brands.min.css" rel="stylesheet">
    <link href="../library/@fortawesome/fontawesome-free/css/solid.min.css" rel="stylesheet">
    <link href="../library/@fortawesome/fontawesome-free/css/regular.min.css" rel="stylesheet">

    <script data-goatcounter="https://d12frosted.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </head>
  <body>
    <header>
      <div class="logo">
        <a href="../">Boris Buliga</a>
      </div>
      <nav>
        <a href="../posts.html" title="Posts">
          <span class="fa-regular fa-file-lines fa-xs"></span>
          Posts
        </a>
        <a href="../projects.html" title="Projects">
          <span class="fa-solid fa-suitcase fa-xs"></span>
          Projects
        </a>
        <!-- <a href="/atom.xml" title="RSS"><span class="fa-solid fa-rss fa-xs"></span>RSS</a> -->
        <a href="https://github.com/d12frosted" title="GitHub">
          <span class="fa-brands fa-github fa-xs"></span>
          GitHub
        </a>
        <a href="https://barberry.io" title="Barberry Garden">
          <span class="fa-solid fa-wine-glass fa-xs"></span>
          Wine
        </a>
      </nav>
    </header>
    
    <main role="main">
      <article>
  <h1>Vulpea v0.3</h1>
  <section class="subtitle">
    Posted on July 14, 2022
    
  </section>
  
  <section class="subtitle">
    Updated on July 20, 2022
  </section>
  
  
  <section class="subtitle">
    Tagged as <a title="All pages tagged 'emacs'." href="../tags/emacs.html">#emacs</a>, <a title="All pages tagged 'org-roam'." href="../tags/org-roam.html">#org-roam</a>, <a title="All pages tagged 'vulpea'." href="../tags/vulpea.html">#vulpea</a>
  </section>
  
  <section>
    <p><img src="../images/2022-07-14-vulpea-0.3/2022-07-20-09-51-46-vulpea-logo.webp" class="img-half" /></p>
<p>The time has come to release a new version of <a href="https://github.com/d12frosted/vulpea">Vulpea</a>, a collection of note-taking functions based on Org and Org Roam. Almost a year has passed since the release of v0.2. Over this time, Vulpea got several major features that deserve a dedicated version. In truth, I wanted to release it almost half a year ago, but the war kicked in, and I had more important things to focus on.</p>
<p>The main focus of this release is the <a href="https://github.com/d12frosted/vulpea#query-from-database">performance of query operations</a>. Expect a 4.5x speed boost for generic <code class="verbatim">vulpea-db-query</code> and even more with specialized queries. All that thanks to materialized view table for notes.</p>
<div class="table-container">
<table>
<caption><code class="verbatim">vulpea-db-query</code> performance on a set of 9554 notes (in seconds)</caption>
<thead>
<tr class="header">
<th>test</th>
<th>result size</th>
<th><a href="https://github.com/d12frosted/vulpea/blob/551495a59fb8c3bcd49a091b233e24e4cb8b584c/vulpea-db.el#L76-L187">regular</a></th>
<th>view table</th>
<th>ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code class="verbatim">tags-some</code></td>
<td>30 notes</td>
<td>4.6693460650999995</td>
<td>1.0112478712</td>
<td>4.6174100</td>
</tr>
<tr class="even">
<td><code class="verbatim">tags-every</code></td>
<td>3168 notes</td>
<td>4.7333844436999996</td>
<td>1.0059819176</td>
<td>4.7052381</td>
</tr>
<tr class="odd">
<td><code class="verbatim">links-some</code></td>
<td>1657 notes</td>
<td>4.8095771283</td>
<td>1.0462236128999999</td>
<td>4.5970833</td>
</tr>
<tr class="even">
<td><code class="verbatim">links-every</code></td>
<td>92 notes</td>
<td>4.5517473337999995</td>
<td>1.0204833089</td>
<td>4.4603839</td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<caption>specialized queries performance on a set of 9554 notes (in seconds)</caption>
<thead>
<tr class="header">
<th>test</th>
<th>result size</th>
<th>generic</th>
<th>specialized</th>
<th>ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code class="verbatim">tags-some</code></td>
<td>30 notes</td>
<td>1.0112478712</td>
<td>0.0066033426</td>
<td>153.14182</td>
</tr>
<tr class="even">
<td><code class="verbatim">tags-every</code></td>
<td>3168 notes</td>
<td>1.0059819176</td>
<td>0.5709392964999999</td>
<td>1.7619770</td>
</tr>
<tr class="odd">
<td><code class="verbatim">links-some</code></td>
<td>1657 notes</td>
<td>1.0462236128999999</td>
<td>0.4248580532</td>
<td>2.4625251</td>
</tr>
<tr class="even">
<td><code class="verbatim">links-every</code></td>
<td>92 notes</td>
<td>1.0204833089</td>
<td>0.0545313596</td>
<td>18.713696</td>
</tr>
</tbody>
</table>
</div>
<p>Checkout <a href="https://github.com/d12frosted/vulpea/blob/master/CHANGELOG.org">CHANGELOG</a> for full list of changes. Read further to learn details.</p>
<!--more-->

<h1 id="2d871a32-af63-4d05-9f99-65e1f5510921" id="materialized-view-table">Materialized view table</h1>
<p>Materialized view table, huh? The concept is actually pretty simple. But first, you need to understand how Org Roam DB is designed.</p>
<p>Under the hood, Org Roam uses SQLite with 7 different tables. Each table stores various information about every single note. There is a table with ‘node’ information like title, level, properties, etc. But tags, aliases, and links are stored in separate tables. And you have to query data from all these tables to get a fully populated note. It <a href="https://github.com/org-roam/org-roam/commit/a199886ef7ae208b0b10dc45e0df9b54d210cd4d">becomes messy</a> and slow if you need to get lots of fully populated notes.</p>
<p>I won’t go too much into detail explaining <a href="https://github.com/d12frosted/vulpea/commit/e2e82fb1288e68f4b84fcd003226fd053677e6c2#diff-45d792d2854eb88fa849977354fe467f09e47c0ca44a51ff5c5b2e1276725a40">how it worked previously in Vulpea</a> and <a href="https://github.com/org-roam/org-roam/blob/c3867619147175faf89ed8f3e90a1e67a4fd9655/org-roam-node.el#L337-L405">how it still works in Org Roam</a>. That deserves a separate post that can be based on my conversation with Jörg Volbers. In short, it uses a trick to multiply all needed tables into one big table. Definitely not my proudest contribution. But most importantly, it is <a href="https://github.com/org-roam/org-roam/commit/a199886ef7ae208b0b10dc45e0df9b54d210cd4d#r52949692">error-prone</a> and slow.</p>
<p>After <a href="https://github.com/d12frosted/vulpea/commit/e2e82fb1288e68f4b84fcd003226fd053677e6c2">adding links</a> to the <code class="verbatim">vulpea-note</code>, I realised that <code class="verbatim">vulpea-db-query</code> became too slow for my collection of notes. And so I decided to add an extra table, where every row contains a fully materialised/populated note. This simple idea provided a 4.5x performance boost to all functions using <code class="verbatim">vulpea-db-query</code>.</p>
<p>This is a game changer with only one downside - write performance degradation. Of course, we write the same data twice - in Org Roam tables and then in materialised view table. But there is more to writing performance degradation. It is hard to hook into Org Roam parsing and writing routine, so I had to duplicate buffer parsing. And this is the biggest performance offender. In most cases, when you simply modify a single note, this is hardly noticeable. But syncing 9k notes takes x2 time.</p>
<div class="table-container">
<table>
<caption>synchronisation performance (in seconds)</caption>
<thead>
<tr class="header">
<th>test</th>
<th>regular</th>
<th>view table</th>
<th>diff</th>
<th>ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>9554 notes</td>
<td>172.79389154999998</td>
<td>337.61603822</td>
<td>164.82215</td>
<td>1.9538656</td>
</tr>
<tr class="even">
<td>small note</td>
<td>0.000354079889</td>
<td>0.000416262194</td>
<td>6.2182305e-5</td>
<td>1.1756166</td>
</tr>
<tr class="odd">
<td>medium note</td>
<td>0.000492199416</td>
<td>0.000539389997</td>
<td>4.7190581e-5</td>
<td>1.0958770</td>
</tr>
<tr class="even">
<td>huge note</td>
<td>0.1732851848</td>
<td>0.2240508243</td>
<td>0.050765640</td>
<td>1.2929601</td>
</tr>
</tbody>
</table>
</div>
<p>This penalty can be omitted if <a href="https://github.com/org-roam/org-roam/issues/1997">materialised view table becomes part of Org Roam</a>. Alternatively, the Org Roam routine can benefit from refactoring to enable this kind of hook without any performance loss. Do I plan to work in this direction? Definitely! But I feel a lack of motivation and resources to promise anything.</p>
<p>See <a href="https://github.com/d12frosted/vulpea/pull/116">vulpea#116</a> for benchmarks.</p>
<h1 id="88017151-c3a0-42db-b16d-a8ddbf4ee66f" id="specialized-queries">Specialized queries</h1>
<p>As I already mentioned, all this performance mumbo jumbo started because of <a href="https://github.com/d12frosted/vulpea/discussions/106">the inclusion of links</a> to <code class="verbatim">vulpea-note</code>. I literally was <a href="https://github.com/d12frosted/vulpea/discussions/106#discussioncomment-1601429">disappointed</a> with the performance. And I decided to take the path of least resistance and provided some specialized queries (because they kind of solve the problem for my most used patterns).</p>
<p>What are the most used patterns? Get the list of notes tagged by all/any given tags. Get the list of notes linking to all/any given notes.</p>
<ul>
<li><code class="verbatim">vulpea-db-query-by-tags-some</code> - return all notes tagged with one of the provided <code class="verbatim">TAGS</code>.</li>
<li><code class="verbatim">vulpea-db-query-by-tags-every</code> - return all notes tagged by every tag from the list of provided <code class="verbatim">TAGS</code>.</li>
<li><code class="verbatim">vulpea-db-query-by-links-some</code> - return all notes linking at least one of the provided <code class="verbatim">DESTINATIONS</code>.</li>
<li><code class="verbatim">vulpea-db-query-by-links-every</code> - return all notes linking each and every provided <code class="verbatim">DESTINATIONS</code>.</li>
</ul>
<p>These are <a href="https://github.com/d12frosted/vulpea/discussions/106#discussioncomment-1601429">benchmark</a> results on a set of 8390 notes before the materialized view was introduced.</p>
<div class="table-container">
<table>
<caption>query by links performance (in seconds)</caption>
<thead>
<tr class="header">
<th>test</th>
<th><code class="verbatim">org-roam</code> API</th>
<th><code class="verbatim">vulpea-db-query</code></th>
<th>specialized</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>simple</td>
<td>0.28974334</td>
<td>2.28282158</td>
<td><strong>0.02278065</strong></td>
</tr>
<tr class="even">
<td>popular</td>
<td>1.85930086</td>
<td>2.34636907</td>
<td><strong>1.42250805</strong></td>
</tr>
<tr class="odd">
<td>big intersection</td>
<td>4.53420141</td>
<td>2.27249325</td>
<td><strong>0.46843158</strong></td>
</tr>
</tbody>
</table>
</div>
<p>What exactly makes specialized queries so fast? We start by narrowing down all notes in the fastest possible way. And then, we exchange this list of ids to list of notes in a single transaction.</p>
<h2 id="8f413ca0-cc75-42ea-9d61-38a27e4d04b7" id="some"><code class="verbatim">*-some</code></h2>
<p>We use <a href="https://www.sqlite.org/lang_expr.html#the_in_and_not_in_operators">IN operator</a> to get notes tagged by at least one of the provided tags.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="kw">distinct</span> node_id</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> tags</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> tag <span class="kw">in</span> (<span class="st">'&quot;wine&quot;'</span>, <span class="st">'&quot;barberry/public&quot;'</span>);</span></code></pre></div>
<p>Ignore serialisation of the string data. It is related to <a href="https://github.com/skeeto/emacsql#limitations">emacsql limitations</a>.</p>
<p>Now that we have the list of ids, we can get list of notes in one transaction by using <code class="verbatim">vulpea-db-query-by-ids</code>.</p>
<h2 id="821ef746-268c-4966-864b-7c7c79bc9fe4" id="every"><code class="verbatim">*-every</code></h2>
<p>We use <a href="https://www.sqlite.org/lang_select.html#compound_select_statements">INTERSECT operator</a> to get notes tagged by all provided tags. Looks more tricky than <code class="verbatim">IN</code> operator, but the idea is simple. We find a list of notes tagged by first tag, a list of notes tagged by second tag, a list of notes tagged by third tag, and so on… And then we calculate intersection of these lists. Voilà!</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="kw">distinct</span> node_id</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> tags</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> tag <span class="op">=</span> <span class="st">'&quot;wine&quot;'</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">INTERSECT</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span> <span class="kw">distinct</span> node_id</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> tags</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span> tag <span class="op">=</span> <span class="st">'&quot;barberry/public&quot;'</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>;</span></code></pre></div>
<p>Now that we have the list of ids, we can get list of notes in one transaction by using <code class="verbatim">vulpea-db-query-by-ids</code>.</p>
<h1 id="145a3aa9-9201-4511-acee-0ee4c2688fa7" id="other-goodies">Other goodies</h1>
<ul>
<li>More data is available in <code class="verbatim">vulpea-note</code>: properties and links.</li>
<li>Note meta is persisted in <code class="verbatim">org-roam-db</code> in <code class="verbatim">meta</code> table.</li>
<li>API to access data from <code class="verbatim">vulpea-note-meta</code>:
<ul>
<li><code class="verbatim">vulpea-note-meta-get-list</code> - to get all values of given <code class="verbatim">PROP</code> and <code class="verbatim">TYPE</code>;</li>
<li><code class="verbatim">vulpea-note-meta-get</code> - to get the first value of given <code class="verbatim">PROP</code> and <code class="verbatim">TYPE</code>.</li>
</ul></li>
<li>New function to remove buffer properties - <code class="verbatim">vulpea-buffer-prop-remove</code>.</li>
<li>Improve <code class="verbatim">filetags</code> handling:
<ul>
<li>Property format them with <code class="verbatim">:</code> as separator;</li>
<li>Remove property when setting them to empty list instead of leaving empty property.</li>
</ul></li>
<li>Allow to configure candidates source for <code class="verbatim">vulpea-find</code> function via <code class="verbatim">vulpea-find-default-candidates-source</code> variable.</li>
<li>New function to select from arbitrary list of notes as opposed to relying on filter - <code class="verbatim">vulpea-select-from</code>.</li>
<li>Add shortcuts for checking tags on the note:
<ul>
<li><code class="verbatim">vulpea-note-tagged-all-p</code> - return non-nil if a <code class="verbatim">NOTE</code> is tagged by all of the <code class="verbatim">TAGS</code>.</li>
<li><code class="verbatim">vulpea-note-tagged-any-p</code> - return non-nil if a <code class="verbatim">NOTE</code> is tagged by any of the <code class="verbatim">TAGS</code>.</li>
</ul></li>
</ul>
<h1 id="f9589a65-e67a-4ba9-b4dd-b0b51a97f909" id="next-steps">Next steps</h1>
<p>Vulpea already offers a lot of features. While working on other projects that use Vulpea, I discover new missing features that I would love to implement. And issue tracker is not empty. Unless something changes, my plan is the following.</p>
<ol type="1">
<li>Add attachment directory path to <code class="verbatim">vulpea-note</code>. This is needed to boost <a href="https://barberry.io">barberry.io</a> construction, so I prioritise this simple feature.</li>
<li>Provide a simple way to add more tables to org-roam-db and improve their initialisation flow.</li>
<li>Provide outline-level <a href="https://github.com/d12frosted/vulpea#metadata">metadata</a>. See <a href="https://github.com/d12frosted/vulpea/issues/75">vulpea#75</a>.</li>
</ol>
<p>Stay tuned and safe travels! Remember to use Emacs responsibly.</p>
  </section>

  <hr />

  <section class="text-right">
    <a target="_blank" class="post-footer-sources" href="https://github.com/d12frosted/d12frosted.io/blob/master/posts/2022-07-14-vulpea-0.3.org">
      <i class="fa fa-code fa-2xs"></i> Sources
    </a>
  </section>

  <script src="https://utteranc.es/client.js" repo="d12frosted/d12frosted.io" issue-term="pathname" label="comments" theme="github-light" crossorigin="anonymous" async>
  </script>
</article>

    </main>

    <footer>
      Site proudly generated by
      <a href="https://github.com/d12frosted/vulpea">Vulpea</a>,
      and
      <a href="http://jaspervdj.be/hakyll">Hakyll</a>
    </footer>

  </body>
</html>

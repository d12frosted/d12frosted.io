<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Utility functions to manage org-roam tags">
    <meta property="og:title" content="Boris Buliga - Org-roam tags" />
    <meta property="og:description" content="Utility functions to manage org-roam tags" />
    <meta property="og:image" content="https://d12frosted.io/images/d12frosted.png" />
    <meta property="og:url" content="https://d12frosted.io/posts/2020-06-10-org-roam-tags.html" />
    <meta property="og:type" content="article" />
    <title>Boris Buliga - Org-roam tags</title>
    <link rel="stylesheet" href="../css/default.css" />
    <link rel="stylesheet" href="../css/fonts.css" />
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
    <link rel="manifest" href="../site.webmanifest">

    <!-- <script defer src="/library/@fortawesome/fontawesome-free/js/solid.js"></script> -->
    <!-- <script defer src="/library/@fortawesome/fontawesome-free/js/brands.js"></script> -->

    <link href="../library/@fortawesome/fontawesome-free/css/fontawesome.min.css" rel="stylesheet">
    <link href="../library/@fortawesome/fontawesome-free/css/brands.min.css" rel="stylesheet">
    <link href="../library/@fortawesome/fontawesome-free/css/solid.min.css" rel="stylesheet">
    <link href="../library/@fortawesome/fontawesome-free/css/regular.min.css" rel="stylesheet">

    <script data-goatcounter="https://d12frosted.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
  </head>
  <body>
    <header>
      <div class="logo">
        <a href="../">Boris Buliga</a>
      </div>
      <nav>
        <a href="../posts.html" title="Posts">
          <span class="fa-regular fa-file-lines fa-xs"></span>
          Posts
        </a>
        <a href="../projects.html" title="Projects">
          <span class="fa-solid fa-suitcase fa-xs"></span>
          Projects
        </a>
        <!-- <a href="/atom.xml" title="RSS"><span class="fa-solid fa-rss fa-xs"></span>RSS</a> -->
        <a href="https://github.com/d12frosted" title="GitHub">
          <span class="fa-brands fa-github fa-xs"></span>
          GitHub
        </a>
        <a href="https://barberry.io" title="Barberry Garden">
          <span class="fa-solid fa-wine-glass fa-xs"></span>
          Wine
        </a>
      </nav>
    </header>
    
    <main role="main">
      <article>
  <h1>Org-roam tags</h1>
  <section class="subtitle">
    Posted on June 10, 2020
    
  </section>
  
  <section class="subtitle">
    Updated on July 20, 2022
  </section>
  
  
  <section class="subtitle">
    Tagged as <a title="All pages tagged 'emacs'." href="../tags/emacs.html">#emacs</a>, <a title="All pages tagged 'org-roam'." href="../tags/org-roam.html">#org-roam</a>
  </section>
  
  <section>
    <p><a href="https://github.com/org-roam/org-roam">Org-roam</a> is a note-taking tool built on top of Emacs and Org. Essentially, it’s a replica of <a href="https://roamresearch.com">Roam Research</a>. These tools provide an easy way to create and manage non-hierarchical notes. If you wish to learn more, just take a look at the <a href="https://org-roam.github.io/org-roam/manual/">Org-roam manual</a> or watch <a href="https://www.youtube.com/watch?v=Lg61ocfxk3c">Making Connections in your Notes</a> video by Matt Williams. Believe me, Org-roam and Roam Research are game-changers. Or even better, don’t believe me and validate my claim by yourself.</p>
<p>Since I am already <a href="../posts/2016-12-20-Being-an-org-mode-addict.html">addicted</a>, it was only natural to prefer <code class="verbatim">org-roam</code> over some web application. Apart from being developed on top of mature Org ecosystem, Emacs brings many merits and extensibility is one of them. Once <code class="verbatim">org-roam</code> introduced tags system in <a href="https://github.com/org-roam/org-roam/blob/master/CHANGELOG.md#111-18-05-2020">v1.1.1</a> I felt the lack of functions to manage them. Adding and removing them by hand is not nice. So in this article I am sharing a snippet that I’ve forged to ease the unbearable lightness of being.</p>
<p><strong>Change Log:</strong></p>
<ul>
<li><code>[2020-10-12 Mon]</code>: Functionality described in this post (and similar functionality to manage aliases) is <a href="https://github.com/org-roam/org-roam/pull/1183">merged to the upstream</a>. Now simply use one of the following functions:
<ul>
<li><code class="verbatim">org-roam-tag-add</code></li>
<li><code class="verbatim">org-roam-tag-delete</code></li>
<li><code class="verbatim">org-roam-alias-add</code></li>
<li><code class="verbatim">org-roam-alias-delete</code></li>
</ul></li>
<li><code>[2021-07-31 Sat]</code>: With <a href="https://github.com/org-roam/org-roam/releases/tag/v2.0.0">release of org-roam v2</a> you should use the following functions:
<ul>
<li><code class="verbatim">org-roam-tag-add</code></li>
<li><code class="verbatim">org-roam-tag-remove</code></li>
<li><code class="verbatim">org-roam-alias-add</code></li>
<li><code class="verbatim">org-roam-alias-remove</code></li>
</ul></li>
</ul>
<!--more-->

<p><img src="../images/2020-06-10-org-roam-tags/2022-07-19-21-01-06-org-roam-tags-demo.gif" /></p>
<p>When it comes to tags removal, I just want to have a list of tags set in the current buffer and chose one of them to remove. Important thing here is that it should not allow me to remove tag set by directories (see <code class="verbatim">org-roam-tag-sources</code>).</p>
<p>On the other hand, when I add a tag, I want to see the list of all tags set either by buffer property or by directory. I can chose one of them (otherwise I tend to mistype) or add a completely new one.</p>
<p>So let’s implement these two functions. But before that, we need to have a function to get the list of buffer wide tags. For this we can write some simple helper (that uses regexps) or reuse internal API from <code class="verbatim">org-roam</code> (that does all the dirty work for us).</p>
<div class="sourceCode" id="cb1" data-org-language="emacs-lisp"><pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> +org-notes-tags-read </span>()</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Return list of tags as set in the buffer.&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  (org-roam--extract-tags-prop (buffer-file-name (buffer-base-buffer))))</span></code></pre></div>
<p>Now it’s easy to implement the function to delete one of the buffer tags.</p>
<div class="sourceCode" id="cb2" data-org-language="emacs-lisp"><pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> +org-notes-tags-delete </span>()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Delete a tag from current note.&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  (interactive)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (+org-notes-buffer-p)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    (user-error <span class="st">&quot;Current buffer is not a note&quot;</span>))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((tags (+org-notes-tags-read))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>         (tag (completing-read <span class="st">&quot;Tag: &quot;</span> tags <span class="kw">nil</span> 'require-match)))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    (+org-buffer-prop-set</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;ROAM_TAGS&quot;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>     (combine-and-quote-strings (<span class="kw">delete</span> tag tags)))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    (org-roam-db--update-tags)))</span></code></pre></div>
<p>Since it works only in the context of <code class="verbatim">org-roam</code> it’s good to have a meaningful error when this function used in the invalid context. Next we read the buffer tags and select one of them using <code class="verbatim">completing-read</code>. The <code class="verbatim">'require-match</code> is just a dummy non-nil value used instead of <code class="verbatim">t</code> as it improves readability.</p>
<p>Next we remove the selected tag from tags and set the result to the buffer property <code class="verbatim">ROAM_TAGS</code>, each tag quoted. Simple as that. I will provide implementation of <code class="verbatim">+org-notes-buffer-p</code> and <code class="verbatim">+org-buffer-prop-set</code> later on.</p>
<p>And the most important function is for adding tags.</p>
<div class="sourceCode" id="cb3" data-org-language="emacs-lisp"><pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> +org-notes-tags-add </span>()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Add a tag to current note.&quot;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  (interactive)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">unless</span> (+org-notes-buffer-p)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    (user-error <span class="st">&quot;Current buffer is not a note&quot;</span>))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let*</span> ((tags (seq-uniq</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                (+seq-flatten</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                 (+seq-flatten</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                  (org-roam-db-query [:select tags :from tags])))))</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>         (tag (completing-read <span class="st">&quot;Tag: &quot;</span> tags)))</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">when</span> (string-empty-p tag)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>      (user-error <span class="st">&quot;Tag can't be empty&quot;</span>))</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    (+org-buffer-prop-set</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;ROAM_TAGS&quot;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>     (combine-and-quote-strings (seq-uniq (<span class="kw">cons</span> tag (+org-notes-tags-read)))))</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    (org-roam-db--update-tags)))</span></code></pre></div>
<p>It also errors out when called outside of <code class="verbatim">org-roam</code> buffer. Then we query all tags from the <code class="verbatim">org-roam-db</code>. Since this is the list of lists of lists, we have two double flatten the result and then leave only unique entries. After that everything is straightforward.</p>
<p>Now the missing functions.</p>
<div class="sourceCode" id="cb4" data-org-language="emacs-lisp"><pre class="sourceCode commonlisp"><code class="sourceCode commonlisp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> +org-notes-buffer-p </span>()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Return non-nil if the currently visited buffer is a note.&quot;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">and</span> buffer-file-name</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">string-equal</span> (file-name-as-directory org-roam-directory)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                     (file-name-directory buffer-file-name))))</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> +seq-flatten </span>(list-of-lists)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Flatten LIST-OF-LISTS.&quot;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">apply</span> #'append list-of-lists))</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> +org-buffer-prop-set </span>(name value)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Set a buffer property called NAME to VALUE.&quot;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  (save-excursion</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    (widen)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    (goto-char (point-min))</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">if</span> (re-search-forward (concat <span class="st">&quot;^</span><span class="ch">#\\</span><span class="st">+&quot;</span> name <span class="st">&quot;: </span><span class="sc">\\</span><span class="st">(.*</span><span class="sc">\\</span><span class="st">)&quot;</span>) (point-max) <span class="kw">t</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        (replace-match (concat <span class="st">&quot;#+&quot;</span> name <span class="st">&quot;: &quot;</span> value))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; find the first line that doesn't begin with ':' or '#'</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">let</span> ((found))</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        (while (<span class="kw">not</span> (<span class="kw">or</span> found (eobp)))</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>          (beginning-of-line)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">if</span> (<span class="kw">or</span> (looking-at <span class="st">&quot;^#&quot;</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                  (looking-at <span class="st">&quot;^:&quot;</span>))</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>              (line-move <span class="dv">1</span> <span class="kw">t</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">setq</span> found <span class="kw">t</span>)))</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        (insert <span class="st">&quot;#+&quot;</span> name <span class="st">&quot;: &quot;</span> value <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)))))</span></code></pre></div>
<p>That’s it. You can find all solution as a gist on <a href="https://gist.github.com/d12frosted/4a55f3d072a813159c1d7b31c21bac9a">GitHub</a>. Have fun!</p>
  </section>

  <hr />

  <section class="text-right">
    <a target="_blank" class="post-footer-sources" href="https://github.com/d12frosted/d12frosted.io/blob/master/posts/2020-06-10-org-roam-tags.org">
      <i class="fa fa-code fa-2xs"></i> Sources
    </a>
  </section>

  <script src="https://utteranc.es/client.js" repo="d12frosted/d12frosted.io" issue-term="pathname" label="comments" theme="github-light" crossorigin="anonymous" async>
  </script>
</article>

    </main>

    <footer>
      Site proudly generated by
      <a href="https://github.com/d12frosted/vulpea">Vulpea</a>,
      and
      <a href="http://jaspervdj.be/hakyll">Hakyll</a>
    </footer>

  </body>
</html>
